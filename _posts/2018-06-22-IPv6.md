---
layout: post
title:  "Pushing IPv6 down the network"
date:   2018-06-22 13:30:30 +0100
categories: debian kvm libvirt openvswitch ipv6
---

It's been a really long time since I posted here. Since my last entries, the network didn't evolve a lot. This post is to move forward and propose IPv6 to the masses (of VM) and then I aim to learn Kubernetes.
The main goal is to install Kubernetes from fedora server spin and IPv6 only helped by calico for networking.

First step is getting /56 networks to the physical hosts. Then I'll propagate the new subnets through BGP using the existing ipsec+gre tunnels.

In order to get my IPv6 blocks, I'm asking them on the wire with dibbler-client package.

## Installing dibbler
- Install the packages
{% highlight shell %}
[root@db-xc1 696 ~]# apt install dibbler-client
{% endhighlight %}

- Modify the config file in /etc/dibbler/client.conf for prefix discovery
{% highlight conf %}
log-level 7
inactive-mode
iface eth0 {
    pd
}
{% endhighlight %}

- Enter the DUID in the right file: /var/lib/dibbler/client-duid

- Configure the system so that the daemon autostart
{% highlight shell %}
[root@db-xc1 696 ~]# cd /etc
[root@db-xc1 697 ~]# ln -s ../init.d/dibbler-client S50dibbler-client
[root@db-xc1 698 ~]# update-rc.d   -f dibbler-client enable 345
[root@db-xc1 699 ~]# update-rc.d  dibbler-client enable
{% endhighlight %}

- Modify the system to have an IP v6 address on eth0
{% highlight conf %}
iface eth0 inet6 static
    address fc01:100:200:400::1
    netmask 64
{% endhighlight %}

- Create ip6tables filter & startup script
{% highlight shell %}
[root@db-xc1 700 ~]# cat /etc/network/if-pre-up.d/ip6tables
#!/bin/sh
/sbin/ip6tables-restore < /etc/ip6tables.up.rules
[root@db-xc1 701 ~]# 
{% endhighlight %}

- Reboot and check that IPv6 is working on the node
ping6 ipv6.google.com & tcpdump -ni eth0 ip6 are your friends

## Update the vm network for IPv6 usage
- Use virsh to update directly the xml file or create a new one
{% highlight shell %}
[root@db-xc1 696 ~]# virsh net-edit VMNetwork
{% endhighlight %}

- Update the xml entry for IPv6
{% highlight xml %}
<network>
  <name>OVSNetwork</name>
  <forward mode='route'/>
  <bridge name='br10' stp='on' delay='0'/>
  <ip address='172.16.4.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='172.16.4.100' end='172.16.4.199'/>
    </dhcp>
  </ip>
  <virtualport type='openvswitch'/>
  <ip family='ipv6' address='fc01:100:200:401::1' prefix='64'>
    <dhcp>
      <range start='fc01:100:200:401::100' end='fc01:100:200:401::1ff'/>
    </dhcp>
  </ip>
</network>
{% endhighlight %}

- In order to take into account the new network, the network has to be restarted and all VMs attached to this network shall be restarted too. May be detach and reattach the network works, I didn't tried.


## Update the Bird configuration file to adapt the routing
- Update on the /etc/bird/bird6.conf file :
{% highlight conf %}
{% endhighlight %}

- Restart the bird daemon and check the routing table
{% highlight shelll %}
[root@db-xc1 35 ~]# service bird6 restart
[root@db-xc1 35 ~]# birdc6 show route 
{% endhighlight %}
